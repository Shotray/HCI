<!DOCTYPE html>
<html>

<head>
    <title>Image Search Engine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <meta http-equiv='cache-control' content="no-cache, must-revalidate, post-check=0, pre-check=0">
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>

    <meta http-equiv="cache-control" content="max-age=0"/>
    <meta http-equiv="cache-control" content="no-cache"/>
    <meta http-equiv="expires" content="0"/>
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"/>
    <meta http-equiv="pragma" content="no-cache"/>
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>

</head>

<body style="background: white;">

<div class="navbar">
    <div class="navbar-inner">
        <h1 class="text-center" style="color:black;"><b>IMAGE SEARCH DEMO </b>&nbsp;&nbsp;&nbsp;</h1>
    </div>
</div>

<div id="main" class="container">
    <table class="table" style="background: white;border: 1px solid beige;box-shadow: 3px 5px 15px 0px rgba(0, 0, 0, 0.2), 3px 5px 15px 0 rgba(0, 0, 0, 0.19);
">
        <tr style="background: lightgrey;">
            <td><b>Chose your file to upload</b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
            <td><b></b></td>
        </tr>
        <tr>
            <td>
                <form method=post enctype=multipart/form-data> <!--<input data-bind="value: title" type="text"
                        id="inputTask" placeholder="Path to the image" style="width: 150px;">-->
                    <input type="file" name="file" id="input-file" required/>
                    <input type=submit value="Search!" onclick="fun()">
                </form>
            </td>
            <td><b></b></td>
        </tr>


        <tr id="row1" style="display:none;">
            <td><p>9 similar pictures found</p></td>
            <td>
                <button class="all">Show All</button>
            </td>
            <td><a href="">
                <button id="clear" style="display:none;">Clear</button>
            </a></td>
            <td><b></b></td>
            <td><b></b></td>
        </tr>

        <tr id="row2" style="display: none">
            <td>
                <p>Tags of pictures:</p>
            </td>
            <td>
                <button id="tag0" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag1" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag2" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag3" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag4" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag5" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag6" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag7" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
            <td>
                <button id="tag8" style="display:none;" class="tags">ALL</button>
            </td>
            </td>
        </tr>
    </table>


</div>
<center>
    <img id="load" src="/images/ajax-loader.gif" style="height:100px;weight:100px;display:none;">
</center>
<div class="container">
    <center>
    <img id="searchimg" src="" class="img-style" style="display:none">
    </center>
    <table id="table" class="table" style="background: white; border: 1px ;display:none;">
        <tbody>
        <tr>
            <td class="td-style">
                <img id="img0" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic0" class="download-pic" src="/images/download.png">
            </td>

            <td class="td-style">
                <img id="img1" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic1" class="download-pic" src="/images/download.png">
            </td>
            <td class="td-style">
                <img id="img2" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic2" class="download-pic" src="/images/download.png">
            </td>
        </tr>
        <tr style="background: white;">
            <td class="td-style">
                <img id="img3" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic3" class="download-pic" src="/images/download.png">
            </td>
            <td class="td-style">
                <img id="img4" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic4" class="download-pic" src="/images/download.png">
            </td>
            <td class="td-style">
                <img id="img5" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic5" class="download-pic" src="/images/download.png">
            </td>
        </tr>
        <tr>
            <td class="td-style">
                <img id="img6" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic6" class="download-pic" src="/images/download.png">

            </td>
            <td class="td-style">
                <img id="img7" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic7" class="download-pic" src="/images/download.png">
            </td>
            <td class="td-style">
                <img id="img8" src="" alt="Norway" class="img-style" width="200" height="200">
                <img id="download-pic8" class="download-pic" src="/images/download.png">
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script type="text/javascript">
    var pythonResponse = {};

    function myFunction() {

        document.getElementById("predictedResult").innerHTML = "";
        $('#clear').hide();
    }

    function init(){
        for (var i=0;i<9;i++) {
            document.getElementById("img" + i).src = "";
            document.getElementById("img" + i).style.display="none";
            document.getElementById("download-pic" + i).style.display="none";
        }
    }

    $("#input-file").change(function () {
        const file = this.files[0];
        if (window.FileReader) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            console.log(reader);
            reader.onloadend = function (e) {
                document.getElementById("searchimg").style.display = 'table';
                document.getElementById("searchimg").src = e.target.result;
            };
        }
    });


    $('.download-pic').click(function () {
        const img = this.parentNode.children[0];
        const download = document.createElement('a');
        const event = new MouseEvent('click');
        download.download = '图片';
        download.href = img.src;
        download.dispatchEvent(event);
    })

    $('.tags').click(function () {
        tag = document.getElementById(this.id).innerText;
        tagPics = []
        for(var idx in pythonResponse.image_list){
            if(pythonResponse.tag_list[idx] == tag) {
                tagPics.push(pythonResponse.image_list[idx]);
            }
        }
        init();
        for (var idx in tagPics) {
            document.getElementById("img" + idx).src = tagPics[idx];
            document.getElementById("img" + idx).style.display="block";
            document.getElementById("download-pic" + idx).style.display="block";
        }
    })

    $('.all').click(function (){
        init();
        for(var idx in pythonResponse.image_list){
            document.getElementById("img" + idx).src = pythonResponse.image_list[idx];
            document.getElementById("img" + idx).style.display="block";
            document.getElementById("download-pic" + idx).style.display="block";
        }
    })

    function fun() {
        $("form").submit(function (evt) {
            //$('#loader-icon').show();

            evt.preventDefault();
            $('#load').show();

            //$('#loader-icon').show();
            var formData = new FormData($(this)[0]);

            $.ajax({
                url: 'imgUpload',
                type: 'POST',
                data: formData,
                //async: false,
                cache: false,
                contentType: false,
                enctype: 'multipart/form-data',
                processData: false,

                success: function (response) {
                    $('#load').hide();
                    $('#row1').show();
                    pythonResponse = response;
                    for (var idx in response.image_list) {
                        document.getElementById("img" + idx).src = response.image_list[idx];
                        document.getElementById("img" + idx).style.display="block";
                    }
                    $('#row2').show();
                    for (var idx in response.tag_set) {
                        document.getElementById("tag" + idx).style.display = 'block';
                        document.getElementById("tag" + idx).innerText = response.tag_set[idx];
                    }
                    // var file = document.getElementById("input-file");
                    // var search_img = document.getElementById("searchimg");
                    // console.log(file.files[0]);
                    // if(file.files && file.files[0]) {
                    //     var reader = new FileReader();
                    //     reader.readAsDataURL(file.files[0]);
                    //     reader.onload = function(){
                    //         console.log(this.result);
                    //         search_img.src = this.result;
                    //     }
                    // }
                    $('#table').show();
                    $('#clear').show();
                }
            });
            return false;
        })
    }
</script>
<style type="text/css">
    img.img-style {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        transition: 0.3s;
        width: 400px;
        height: 300px;
        padding: 5px 0px 5px 5px;
        border-left-width: 0px;
        border-bottom-width: 0px;
        border-right-width: 0px;
    }

    img.download-pic {
        position: absolute;
        bottom: 15px;
        right: 15px;
        z-index: 10;
        width: 10%;
        transition: all 0.1s;
        cursor: pointer;
    }

    td.td-style {
        border: none;
        position: relative;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        transition: 0.3s;
        width: 200px;
        height: 200px;
        padding: 0px;
        border-left-width: 1px;
        border-bottom-width: 1px;
        border-right-width: 1px;
        background: white;
    }


</style>
</body>
</html>